@using CI_Platform.Entities.ViewModels
 @model VolunteeringTimesheetModel
@{
        Layout  = "Header";
 }
 <style>
        .modal-header,
        .modal-footer {
            border: none;
        }
        
        .table>:not(caption)>*>* {
            border-bottom-width: 0px;
        }
        .imghover{
            cursor: pointer;
        }
        .cancle-btnn ,
        .orangeButton{
            width:10vh;
        }
        .orangeButton i ::before {
        color: #F88634;
    }
    .orangeButton i :hover {
        color: black;
    }
    .modal-footer {
    justify-content: center;
}

.table-scrollable {
  max-height: 400px; /* Set the maximum height for the scrollable area */
  overflow-y: auto; /* Enable vertical scrolling */
}


 </style>

<body>
    <div id="reload" class="container">
        <br><br><br>
        <h1>Volunteering Timesheet</h1>
        <br>
        <div class="row d-flex justify-content-around">
            <div class="col-lg-6 col-12 mb-3">
                <div class="row">

            <!----------------------------------------------- timesheet for time based missions ----------------------------------------->

                    <div class="col-lg-11 col-12 border table-responsive" >
                        <br>
                        <div class="d-flex justify-content-between">
                            <p class="h6 my-auto">Volunteering Hours</p>
                            <a data-bs-toggle="modal" data-bs-target="#exampleModal"><button type="button" class="orangeButton" onclick="ShowTimeTimesheet(1,null,null,null,null,null,null,null,null);"><i class="fa-solid fa-plus"></i> Add</button></a>
                        </div>
                        <div class="table-scrollable mt-3">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th scope="col">Mission</th>
                                        <th scope="col">Date</th>
                                        <th scope="col">Hours</th>
                                        <th scope="col">Minutes</th>
                                    </tr>
                                </thead>
                            
                                    <tbody>
                                            @foreach (var item in Model.timesheetModel.Where(t => t.MissionType == 0))
                                            {
                                                <tr>
                                                    <td>@item.MissionName</td>
                                                    <td>@item.timeSheet.DateVolunteered.ToString("dd/MM/yyyy").Replace("-", "/")</td>
                                                    <td>@(item.timeSheet.Time?.Hours + "h")</td>
                                                    <td>@(item.timeSheet.Time?.Minutes+ "min")</td>
                                                    <td class="d-flex">
                                                        <a class="me-2" data-bs-toggle="modal" data-bs-target="#exampleModal" onclick="ShowTimeTimesheet(2, @item.timeSheet.MissionId, '@item.timeSheet.DateVolunteered.ToString("yyyy/MM/dd")', '@(item.timeSheet.Time?.Hours)', '@(item.timeSheet.Time?.Minutes)' ,'@item.timeSheet.Notes' , @item.timeSheet.TimesheetId, '@item.missionStartDate.ToString("yyyy/MM/dd")', '@item.missionEndDate.ToString("yyyy/MM/dd")'  )"><img class="imghover" src="~/images/editing.png" alt=""></a>
                                                        <a class="" data-bs-toggle="modal" data-bs-target="#exampleModalToggle" onclick="DeleteTimesheet(@item.timeSheet.TimesheetId);"><img class="imghover" src="~/images/bin.png" alt=""></a>
                                                    </td>
                                                </tr>
                                            }
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!----------------------------------------------- timesheet for goal based missions ----------------------------------------->

            <div class="col-lg-6 col-12">
                <div class="row">
                    <div class="col-lg-11 col-12 border table-responsive" >
                        <br>
                        <div class="d-flex justify-content-between">
                            <p class="h6 my-auto">Volunteering Goals</p>
                            <a data-bs-toggle="modal" data-bs-target="#exampleModal1" onclick="ShowGoalTimesheet(1,null,null,null,null,null,null,null);"><button type="button" class="orangeButton"><i class="fa-solid fa-plus"></i> Add</button></a>
                        </div>
                        <div class="table-scrollable mt-3">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th scope="col">Mission</th>
                                        <th scope="col">Date</th>
                                        <th scope="col">Action</th>
                                    </tr>
                                </thead>

                                <tbody>
                                        @foreach (var item in Model.timesheetModel.Where(t => t.MissionType == 1))
                                        {
                                            <tr>
                                                <td>@item.MissionName</td>
                                                <td>@item.timeSheet.DateVolunteered.ToString("dd/MM/yyyy").Replace("-", "/")</td>
                                                <td>@item.timeSheet.Action</td>
                                                <td class="d-flex">
                                                    <a class="me-2" data-bs-toggle="modal" data-bs-target="#exampleModal1" onclick="ShowGoalTimesheet(2, @item.timeSheet.MissionId , '@item.timeSheet.DateVolunteered.ToString("yyyy/MM/dd")', '@item.timeSheet.Action', '@item.timeSheet.Notes' ,@item.timeSheet.TimesheetId, '@item.missionStartDate.ToString("yyyy/MM/dd")', '@item.missionEndDate.ToString("yyyy/MM/dd")' )"><img class="imghover" src="~/images/editing.png"></a>
                                                    <a class="" data-bs-toggle="modal" data-bs-target="#exampleModalToggle" onclick="DeleteTimesheet(@item.timeSheet.TimesheetId);"><img class="imghover" src="~/images/bin.png" alt=""></a>
                                                </td>
                                            </tr>
                                        }
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <br /><br />

    <!-- modal for edit sheet for time based -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
                <div class="modal-header b-0">
                    <h5 class="modal-title mx-2" id="exampleModalLabel" style="color:#414141;">Please input below Volunteering Hours</h5>
                    <button type="button" class="closebox btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row justify-content-center">
                        <div class="fs-5 fw-bold text-center" id="email_msg"></div>
                        <div class="col-11">
                            <label for="name">Mission</label>
                            <select id="timemission" class="form-select" aria-label="Default select example">
                                <option value="0" selected disabled>select mission</option>
                                @foreach (var item in @Model.MissionList.Where(m => m.Selected == true))
                                {
                                    <option value="@item.Value">@item.Text</option>
                                }
                               
                            </select>
                            <span id="nameMessage"></span>

                            <label class="mt-3" for="date">Date Volunteered</label>
                            <input type="date" id="timedate" class="form-control" />
                            <span id="emailMessage"></span>



                            <div class="form-group row">
                                <div class="col-lg-6 col-sm-12">
                                    <label class="mt-3" for="Hours">Hours</label>
                                    <input type="number" max="24" class="form-control" id="hour" placeholder="Enter Spent Hours">
                                </div>

                                <div class="col-lg-6 col-sm-12 ">
                                    <label class="mt-3" for="Minutes">Minutes</label>
                                    <div class="input-group">
                                        <input type="number" max="60" class="form-control" id="min" placeholder="Enter Spent Minutes" />
                                    </div>
                                </div>
                            </div>

                            <label class="mt-3" for="msg">Message</label>
                            <textarea class="form-control" rows="4" id="timemsg" placeholder="Enter your Message"></textarea>
                            <span id="messagE"></span>
                        </div>
                    </div>

                </div>
                <div class="modal-footer d-flex justify-content-end">

                    <button type="button" class="closebox btnn cancle-btnn" data-bs-dismiss="modal">cancel</button>
                    <button type="button" id="timeSubmit" class="orangeButton">Save</button>
                </div>
            </div>
        </div>
    </div>
    <!-- modal for edit sheet for goal based -->
    <div class="modal fade" id="exampleModal1" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
                <div class="modal-header b-0">
                    <h5 class="modal-title mx-2" id="exampleModalLabel" style="color:#414141;">Please input below Volunteering Goal</h5>
                    <button type="button" class="closebox btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row justify-content-center">
                        <div class="fs-5 fw-bold text-center" id="email_msg"></div>
                        <div class="col-11">
                            <label for="name">Mission</label>
                            <select class="form-select" id="goalmission" aria-label="Default select example">
                                <option value="0" selected disabled>select mission</option>
                                @foreach (var item in @Model.MissionList.Where(m => m.Selected == false))
                                {
                                    <option value="@item.Value">@item.Text</option>
                                }
                            </select>
                            <span id="nameMessage"></span>

                            <label class="mt-3" for="date">Actions</label>
                            <input type="number" id="goalaction" class="form-control" placeholder="Enter Actions" />
                            <span id="emailMessage"></span>

                            <label class="mt-3" for="date">Date Volunteered</label>
                            <input type="date" id="goaldate" class="form-control" />
                            <span id="emailMessage"></span>

                            <label class="mt-3" for="msg">Message</label>
                            <textarea class="form-control" id="goalmsg" rows="4" placeholder="Enter your Message"></textarea>
                            <span id="messagE"></span>
                        </div>
                    </div>

                </div>
                <div class="modal-footer d-flex justify-content-end">

                    <button type="button" class="closebox btnn cancle-btnn" data-bs-dismiss="modal">cancel</button>
                    <button type="button" id="goalSubmit" class="orangeButton">Save</button>
                </div>
            </div>
        </div>
    </div>
    <!-- modal for delet sheet  -->
    <div class="modal fade" id="exampleModalToggle" aria-hidden="true" aria-labelledby="exampleModalToggleLabel" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalToggleLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <b> Are You sure you want to delete this item ?</b>
                </div>
                <div class="modal-footer">
                    <button type="button" id="yes" data-bs-dismiss="modal" class="orangeButton">Yes</button>
                    <button type="button" class="orangeButton" data-bs-dismiss="modal">No</button>
                </div>
            </div>
        </div>
    </div>
    
     <!-------------------------------------------------- privacy policy  --------------------------------------------------------->

                        @{

                            Html.RenderPartial("Footer");
                   
                         }

</body>

<!----------------------------------------------------    java script    ---------------------------------------------------->
<script>

    // Get the hour & minut input element
    const hourInput = document.getElementById("hour");
    const minInput = document.getElementById("min");
    hourInput.max = 23;
    minInput.max = 59;
    // Add an event listener to the input element to validate the value
    hourInput.addEventListener("input", function() {
      if (this.value > 23) {
        this.value = 23;
      }
    });
    minInput.addEventListener("input", function() {
      if (this.value > 59) {
        this.value = 59;
      }
    });



    function ShowGoalTimesheet(data,missionid,date,action,notes,timesheetid,startDate,endDate){
            if(data == 1){
                $("#goalmission option:first-child").prop("selected", true);
               $('#goaldate , #goalmsg , #goalaction').val('');
               $("#goalmission").prop("disabled", false);
               $("#goalSubmit").click(function(){
                    EditGoalTimesheet(timesheetid)
                });

            }
           if(data == 2){
                console.log(missionid);
                $('#goalmission').val(missionid);
                $("#goaldate").val(date);
                $("#goalmission").prop("disabled", true);
                $("#goaldate").attr("min" ,  startDate );
                $("#goaldate").attr("max" ,  endDate );
                $("#goalmsg").val(notes);
                $("#goalaction").val(action);
                $("#goalSubmit").click(function(){
                    EditGoalTimesheet(timesheetid)
                });
           }
           
        
    }

     function EditGoalTimesheet(timesheetid){

        var missionid = $('#goalmission').val();
        var date = $("#goaldate").val();
        var msg =  $("#goalmsg").val();
        var action = $("#goalaction").val();
        
        if (missionid == null ||
            date == "" ||
            msg.trim() == "" ||
            action.trim() == "" 
            )
            {
                toastr.error('All Fields are required', '', {
                });
                return
            }

         $.ajax({
            url: "/Story/EditTimesheet",
            type: "POST",
            data: {

                'TimesheetId': timesheetid,
                'MissionId': missionid,
                'DateVolunteered': date,
                'Notes': msg,
                'Action': action
                
            },
            success: function (data) {
                toastr.success('Timesheet Saved Successfully', '', {
                });
                $('#exampleModal1').modal('hide');
                //$('#reload').load(location.href + ' #reload  >*');
                
                setTimeout(function () {
                    location.reload();
                }, 300);
             },
            error: function () {
                alert("hi error");
            }
        });
    }

    function ShowTimeTimesheet(data,missionid,date,hour,minutes,notes,timesheetid,startDate,endDate){
                if(data == 1){
                $("#timemission option:first-child").prop("selected", true);
                   $('#timedate , #timemsg , #hour , #min').val('');
                    $("#timemission").prop("disabled", false);
                   $("#timeSubmit").click(function(){
                        EditTimeTimesheet(timesheetid)
                    });

                }
                if(data == 2){
                    $('#timemission').val(missionid);
                    $("#timemission").prop("disabled", true);
                    $("#timedate").val(date);
                    $("#timedate").attr("min" ,  startDate );
                    $("#timedate").attr("max" ,  endDate );
                    console.log(startDate,endDate);
                    $("#timemsg").val(notes);
                    $("#hour").val(hour);
                    $("#min").val(minutes);
                    $("#timeSubmit").click(function(){
                        EditTimeTimesheet(timesheetid)
                    });
               }
    }


    function EditTimeTimesheet(timesheetid){

        var missionid = $('#timemission').val();
        var date = $("#timedate").val();
        var msg =  $("#timemsg").val();
        var hour = $("#hour").val();
        var min =  $("#min").val();
        var formatedtime = hour + ":" + min + ":00";
        
     if (missionid == null ||
            date == "" ||
            msg.trim() == "" ||
            hour.trim() == "" ||
            min.trim() == "" 
            )
            {
                 toastr.error('All Fields are required', '', {
                });
                return
            }

         $.ajax({
            url: "/Story/EditTimesheet",
            type: "POST",
            data: {

                'TimesheetId': timesheetid,
                'MissionId': missionid,
                'DateVolunteered': date,
                'Notes': msg,
                'Time': formatedtime
                
            },
            success: function (data) {
                toastr.success('Timesheet Saved Successfully', '', {
                });
                $('#exampleModal').modal('hide');
                //$('#reload').load(location.href + ' #reload  >*');
                setTimeout(function () {
                    location.reload();
                }, 300); 
            },
            error: function () {
                alert("hi error");
            }
        });
    }


   
    function DeleteTimesheet(timesheetid){
         $("#yes").click(function(){
                    DeleteTimeTimesheet(timesheetid)
                });
    }

    function  DeleteTimeTimesheet(timesheetid){


         $.ajax({
            url: "/Story/DeleteTimesheet",
            type: "POST",
            data: {

                'TimesheetId': timesheetid
            },
            success: function (data) {
                $('#reload').load(location.href + ' #reload  >*');
            },
            error: function () {
                alert("hi error");
            }
        });

    }

   $("#goalmission").on('change', function() {
        var SelectedMissionId = $("#goalmission option:selected").val()
        
        $.ajax({
            type: "POST",
            url: "/Story/MissionDateRange",
            data: {
                'Missionid': SelectedMissionId,
            },
            success: function(data) {
                let formattedStartDate = data.missionStartDate.substr(0, 10);
                let formattedEndDate = data.missionEndDate.substr(0, 10);
                $("#goaldate").attr('min', formattedStartDate);
                $("#goaldate").attr('max', formattedEndDate);
                SelectedMissionId = 0;
            },
            error: function() {
                alert('error');
            }
        })
    })

    $("#timemission").on('change', function() {
        var SelectedMissionId = $("#timemission option:selected").val()
        
        $.ajax({
            type: "POST",
            url: "/Story/MissionDateRange",
            data: {
                'Missionid': SelectedMissionId,
            },
            success: function(data) {
                let formattedStartDate = data.missionStartDate.substr(0, 10);
                let formattedEndDate = data.missionEndDate.substr(0, 10);
                $("#timedate").attr('min', formattedStartDate);
                $("#timedate").attr('max', formattedEndDate);
                SelectedMissionId = 0;
            },
            error: function() {
                alert('error');
            }
        })
    })

</script>